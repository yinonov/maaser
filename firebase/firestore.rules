rules_version = '2';

// Firestore Security Rules for HaMaaser MVP
// Based on data-model.md from specs/001-mvp-platform-spec

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper Functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isNGOAdmin(ngoId) {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/ngos/$(ngoId))
               .data.adminUsers.hasAny([request.auth.uid]);
    }
    
    function isPlatformAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid))
               .data.profileType == 'platform_admin';
    }
    
    // Users Collection
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow create: if isAuthenticated() && isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if false; // No user deletion in MVP
    }
    
    // NGOs Collection
    match /ngos/{ngoId} {
      allow read: if true; // Public read for all users
      allow create: if isPlatformAdmin();
      allow update: if isNGOAdmin(ngoId) || isPlatformAdmin();
      allow delete: if isPlatformAdmin();
    }
    
    // Stories Collection
    match /stories/{storyId} {
      allow read: if resource.data.status == 'active' || 
                     isNGOAdmin(resource.data.ngoId) || 
                     isPlatformAdmin();
      allow create: if isAuthenticated() && isNGOAdmin(request.resource.data.ngoId);
      allow update: if isNGOAdmin(resource.data.ngoId) || isPlatformAdmin();
      allow delete: if isNGOAdmin(resource.data.ngoId) || isPlatformAdmin();
    }
    
    // Donations Collection
    match /donations/{donationId} {
      allow read: if isOwner(resource.data.userId) || 
                     isNGOAdmin(resource.data.ngoId) ||
                     isPlatformAdmin();
      allow create: if isAuthenticated(); // Payment intent creation
      allow update: if false; // Only Cloud Functions can update
      allow delete: if false; // No deletion (audit trail)
    }
    
    // Admin Actions (Audit Log)
    match /admin_actions/{actionId} {
      allow read: if isPlatformAdmin();
      allow create: if isPlatformAdmin();
      allow update, delete: if false; // Immutable audit log
    }
  }
}

