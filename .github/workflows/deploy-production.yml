name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag to deploy (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: read

jobs:
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: production
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version }}
      
      - name: Verify version tag
        run: |
          if ! git describe --tags --exact-match 2>/dev/null; then
            echo "Error: Not on a tagged commit"
            exit 1
          fi
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install root dependencies
        run: npm ci
      
      - name: Install Firebase CLI
        run: npm install -g firebase-tools
      
      - name: Install Vercel CLI
        run: npm install -g vercel
      
      - name: Install EAS CLI
        run: npm install -g eas-cli
      
      - name: Setup environment configuration
        run: |
          ./scripts/deploy/setup-environments.sh || true
      
      - name: Check secrets
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          ./scripts/deploy/check-secrets.sh prod || echo "Warning: Some secrets may be missing"
      
      - name: Deploy Functions
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
          CI: true
          FORCE: true
        run: |
          ./scripts/deploy/deploy-functions.sh prod --force
      
      - name: Deploy Dashboard
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          CI: true
        run: |
          ./scripts/deploy/deploy-dashboard.sh prod --production
      
      - name: Build and Submit Mobile Apps
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          APPLE_API_KEY: ${{ secrets.APPLE_API_KEY }}
          GOOGLE_SERVICE_ACCOUNT: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}
          CI: true
        run: |
          ./scripts/deploy/deploy-mobile.sh prod --platform all --submit
        continue-on-error: true
      
      - name: Create deployment record
        run: |
          echo "Deployment completed at $(date)"
          echo "Version: ${{ github.event.inputs.version }}"
          echo "Commit: ${{ github.sha }}"
      
      - name: Send success notification
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"✅ Production deployment of ${{ github.event.inputs.version }} completed successfully\"}" \
            $SLACK_WEBHOOK_URL || true
      
      - name: Send failure notification
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"❌ Production deployment of ${{ github.event.inputs.version }} failed\"}" \
            $SLACK_WEBHOOK_URL || true
      
      - name: Rollback on failure
        if: failure()
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          echo "Deployment failed. Manual rollback may be required."
          echo "Run: ./scripts/deploy/rollback.sh prod"
